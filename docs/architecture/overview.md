# üèóÔ∏è Arquitectura del Sistema - MH-Next

## üìã **Resumen Ejecutivo**

**MH-Next** implementa una arquitectura moderna de **Single Page Application (SPA)** construida sobre **Next.js 15 App Router**, dise√±ada para manejar las operaciones complejas de gesti√≥n de supermercados. El sistema sigue patrones arquitect√≥nicos establecidos con separaci√≥n clara de responsabilidades y escalabilidad horizontal.

---

## üéØ **Principios Arquitect√≥nicos**

### **1. Separation of Concerns (SoC)**
- **Presentaci√≥n**: Componentes React puros
- **L√≥gica de Negocio**: Custom Hooks especializados  
- **Acceso a Datos**: Servicios centralizados
- **Estado**: Gesti√≥n h√≠brida (Server/Client State)

### **2. Composition over Inheritance**
- Componentes modulares y reutilizables
- Hooks composables para l√≥gica compartida
- Providers especializados por dominio

### **3. Single Responsibility Principle**
- Un hook por funcionalidad espec√≠fica
- Servicios especializados por m√≥dulo
- Componentes con prop√≥sito √∫nico

### **4. Dependency Injection**
- Context API para dependencias globales
- Servicios inyectables via hooks
- Configuraci√≥n centralizada

---

## üèõÔ∏è **Arquitectura de Alto Nivel**

```mermaid
graph TB
    subgraph "Frontend Layer"
        A[Next.js App Router] --> B[React 19 Components]
        B --> C[Material-UI v7]
        C --> D[Framer Motion]
    end
    
    subgraph "State Management"
        E[TanStack Query] --> F[Server State]
        G[React Context] --> H[Client State]
        I[Local Storage] --> J[Persistent State]
    end
    
    subgraph "Business Logic"
        K[Custom Hooks] --> L[Service Layer]
        L --> M[API Integration]
        M --> N[Backend APIs]
    end
    
    subgraph "Data Flow"
        O[User Interaction] --> P[Components]
        P --> Q[Hooks]
        Q --> R[Services]
        R --> S[Backend]
        S --> T[Database]
    end
    
    A --> E
    B --> K
    E --> L
    G --> K
```

---

## üìä **Patrones Arquitect√≥nicos Implementados**

### **1. Model-View-Controller (MVC) Adaptado**

```typescript
// Model: Types + Services
interface NominaCantera {
  id: number;
  numero_nomina: string;
  // ... m√°s propiedades
}

// View: React Components
export default function NominasPage() {
  // UI Logic only
}

// Controller: Custom Hooks
export const useNominasCheque = () => {
  // Business logic
  // State management
  // Service orchestration
}
```

### **2. Repository Pattern**

```typescript
// Abstract Service Interface
interface INominaChequeService {
  getNominas(filtros: FiltrosNominas): Promise<NominasResponse>;
  crearNomina(data: CrearNominaRequest): Promise<NominaCantera>;
}

// Concrete Implementation
class NominaChequeService implements INominaChequeService {
  // Implementation details
}
```

### **3. Observer Pattern (React Context)**

```typescript
// Observable State
export const AuthContext = createContext<AuthContextType>();

// Observers (Components)
const Dashboard = () => {
  const { usuario } = useAuth(); // Observes auth changes
}
```

### **4. Command Pattern (Actions)**

```typescript
// Commands encapsulated in hooks
const { crearNomina, eliminarNomina, actualizarTracking } = useNominasCheque();

// Each action is a command with specific responsibility
```

---

## üîÑ **Flujo de Datos**

### **1. Flujo de Lectura (Query)**

```mermaid
sequenceDiagram
    participant U as Usuario
    participant C as Componente
    participant H as Hook
    participant TQ as TanStack Query
    participant S as Service
    participant API as Backend API
    
    U->>C: Interacci√≥n
    C->>H: useNominas()
    H->>TQ: useQuery()
    TQ->>S: nominaService.getNominas()
    S->>API: GET /api/nominas
    API-->>S: Response Data
    S-->>TQ: Processed Data
    TQ-->>H: Cached Data
    H-->>C: State + Actions
    C-->>U: UI Update
```

### **2. Flujo de Escritura (Mutation)**

```mermaid
sequenceDiagram
    participant U as Usuario
    participant C as Componente
    participant H as Hook
    participant TQ as TanStack Query
    participant S as Service
    participant API as Backend API
    
    U->>C: Acci√≥n (crear/editar)
    C->>H: crearNomina()
    H->>TQ: useMutation()
    TQ->>S: nominaService.crearNomina()
    S->>API: POST /api/nominas
    API-->>S: Success Response
    S-->>TQ: Updated Data
    TQ->>TQ: Invalidate Cache
    TQ-->>H: Success State
    H-->>C: UI Feedback
    C-->>U: Success Message
```

---

## üìÅ **Arquitectura por Capas**

### **Layer 1: Presentation (UI)**
```
src/app/                    # Next.js App Router Pages
src/components/            # React Components
‚îú‚îÄ‚îÄ dashboard/            # Business Components  
‚îú‚îÄ‚îÄ ui/                  # Generic UI Components
‚îú‚îÄ‚îÄ landing/             # Marketing Components
‚îî‚îÄ‚îÄ shared/              # Cross-cutting Components
```

### **Layer 2: Business Logic**
```
src/hooks/                 # Custom Business Hooks
‚îú‚îÄ‚îÄ useNominasCheque.ts   # Nominas domain logic
‚îú‚îÄ‚îÄ useFacturas.ts        # Facturas domain logic
‚îú‚îÄ‚îÄ useCajaChica.ts       # Caja Chica domain logic
‚îî‚îÄ‚îÄ useAuth.ts            # Authentication logic
```

### **Layer 3: Data Access**
```
src/services/             # API Service Layer
‚îú‚îÄ‚îÄ nominaChequeService.ts
‚îú‚îÄ‚îÄ facturaService.ts
‚îú‚îÄ‚îÄ authService.ts
‚îî‚îÄ‚îÄ apiConfig.ts          # HTTP Configuration
```

### **Layer 4: Infrastructure**
```
src/utils/                # Utilities & Helpers
src/types/                # TypeScript Definitions
src/constants/            # Application Constants
src/providers/            # Global Providers
```

---

## üé® **Gesti√≥n de Estado**

### **1. Server State (TanStack Query)**

```typescript
// Cached, synchronized with backend
const { data: nominas, isLoading, error } = useQuery({
  queryKey: ['nominas', filtros],
  queryFn: () => nominaService.getNominas(filtros),
  staleTime: 5 * 60 * 1000, // 5 minutes
});
```

**Caracter√≠sticas:**
- ‚úÖ Cache autom√°tico con TTL
- ‚úÖ Background refetch
- ‚úÖ Optimistic updates
- ‚úÖ Error boundary integration
- ‚úÖ Pagination support

### **2. Client State (React Context + useState)**

```typescript
// Local UI state
const [modalOpen, setModalOpen] = useState(false);
const [selectedItem, setSelectedItem] = useState(null);

// Global app state
const { usuario, login, logout } = useAuth();
```

**Caracter√≠sticas:**
- ‚úÖ Minimal global state
- ‚úÖ Component-local state preferred
- ‚úÖ Context for cross-cutting concerns
- ‚úÖ No unnecessary re-renders

### **3. Persistent State (localStorage)**

```typescript
// Authentication tokens
localStorage.setItem('authToken', token);

// User preferences
localStorage.setItem('theme', 'dark');
```

---

## üîê **Arquitectura de Autenticaci√≥n**

### **‚ö†Ô∏è Estado Actual (Requiere Refactorizaci√≥n)**

El sistema implementa **m√∫ltiples patrones de autenticaci√≥n** que necesitan unificaci√≥n:

```mermaid
graph TD
    A[Usuario Login] --> B{M√∫ltiples Paths}
    
    B --> C[AuthContext.tsx]
    B --> D[useAuth.ts]  
    B --> E[useAuthStatus.ts]
    B --> F[middleware.ts]
    
    C --> G[localStorage authToken]
    D --> H[localStorage usuario]
    E --> I[API /me endpoint]
    F --> J[cookies authToken]
    
    G --> K[Axios interceptors]
    H --> K
    I --> K
    J --> L[Next.js middleware]
    
    K --> M[Backend Validation]
    L --> M
```

**Problemas Identificados:**
- üî¥ **Duplicaci√≥n de l√≥gica** en m√∫ltiples hooks
- üî¥ **Inconsistencia** entre localStorage y cookies
- üî¥ **Complejidad** de mantenimiento
- üî¥ **Falta de centralizaci√≥n** de tokens

### **üéØ Arquitectura Objetivo (NextAuth.js)**

```mermaid
graph TD
    A[Usuario Login] --> B[NextAuth.js]
    B --> C[Unified Session Management]
    C --> D[JWT Tokens]
    D --> E[Automatic Refresh]
    E --> F[Backend Integration]
    F --> G[Consistent State]
```

---

## üß© **Patrones de Componentes**

### **1. Container/Presentational Pattern**

```typescript
// Container (Smart Component)
export default function NominasPage() {
  const { nominas, loading, crearNomina } = useNominasCheque();
  
  return (
    <NominasList 
      nominas={nominas}
      loading={loading}
      onCrear={crearNomina}
    />
  );
}

// Presentational (Dumb Component)  
export function NominasList({ nominas, loading, onCrear }) {
  // Only UI logic, no business logic
}
```

### **2. Compound Components Pattern**

```typescript
// Main component with sub-components
export function Modal({ children }) {
  return <div className="modal">{children}</div>;
}

Modal.Header = function ModalHeader({ children }) {
  return <div className="modal-header">{children}</div>;
};

Modal.Body = function ModalBody({ children }) {
  return <div className="modal-body">{children}</div>;
};
```

### **3. Render Props Pattern (via Hooks)**

```typescript
// Custom hook as render prop alternative
export function useAnimations(config) {
  // Animation logic
  return { animate, controls, variants };
}

// Usage in component
export function AnimatedComponent() {
  const { animate } = useAnimations({ preset: 'fade' });
  return <div {...animate}>Content</div>;
}
```

---

## üéØ **M√≥dulos del Sistema**

### **1. Dashboard Core**
```
Responsabilidad: Navegaci√≥n, m√©tricas, layout principal
Componentes: Sidebar, AppBar, MetricsDashboard
Hooks: useAuthStatus, usePrefetch, useMetrics
```

### **2. Gesti√≥n de N√≥minas**
```
Responsabilidad: Cheques, facturas, tracking
Componentes: NominasPage, FacturasAsignadasView
Hooks: useNominasCheque, useNominasGastos
Services: nominaChequeService, nominasGastosService
```

### **3. Control Financiero**
```
Responsabilidad: Caja chica, facturas, gastos
Componentes: CajaChicaPage, FacturasPage
Hooks: useCajaChica, useFacturas, useGastos
```

### **4. Gesti√≥n de Inventario**
```
Responsabilidad: Stock, productos, movimientos
Componentes: BodegaPages, StockComponents
Hooks: useStock, useProductos
```

### **5. Administraci√≥n**
```
Responsabilidad: Usuarios, configuraci√≥n, reportes
Componentes: UsuariosPage, ConfiguracionPage
Hooks: useUsuarios, useAuth
```

---

## ‚ö° **Optimizaciones de Performance**

### **1. Code Splitting**
```typescript
// Route-based splitting (automatic with App Router)
// Component-based splitting
const HeavyComponent = lazy(() => import('./HeavyComponent'));

// Dynamic imports for large libraries
const { jsPDF } = await import('jspdf');
```

### **2. Data Fetching Optimization**
```typescript
// Parallel queries
const queries = useQueries([
  { queryKey: ['nominas'], queryFn: getNominas },
  { queryKey: ['usuarios'], queryFn: getUsuarios },
  { queryKey: ['facturas'], queryFn: getFacturas }
]);

// Prefetching critical data
usePrefetch(['nominas', 'usuarios']);
```

### **3. Re-render Optimization**
```typescript
// Memoized components
const ExpensiveComponent = memo(({ data }) => {
  return <ComplexVisualization data={data} />;
});

// Memoized callbacks
const handleClick = useCallback((id) => {
  onItemClick(id);
}, [onItemClick]);
```

---

## üîß **Configuraci√≥n y Setup**

### **1. Build Configuration**
```typescript
// next.config.ts
export default {
  experimental: {
    turbopack: true, // Development speed
  },
  compiler: {
    emotion: true, // MUI optimization
  },
  webpack: (config) => {
    // Custom optimizations
    return config;
  }
};
```

### **2. TypeScript Configuration**
```json
// tsconfig.json
{
  "compilerOptions": {
    "strict": true,
    "noUncheckedIndexedAccess": true,
    "exactOptionalPropertyTypes": true
  }
}
```

### **3. ESLint Configuration**
```javascript
// eslint.config.mjs
export default [
  ...nextConfig,
  {
    rules: {
      "@typescript-eslint/no-unused-vars": "error",
      "react-hooks/exhaustive-deps": "error"
    }
  }
];
```

---

## üìä **M√©tricas y Monitoreo**

### **1. Performance Monitoring**
```typescript
// Vercel Speed Insights
import { SpeedInsights } from '@vercel/speed-insights/next';

// Custom metrics
const useMetrics = () => {
  const trackEvent = (name: string, data: object) => {
    // Analytics tracking
  };
};
```

### **2. Error Boundary**
```typescript
// Global error handling
export function GlobalErrorBoundary({ children }) {
  return (
    <ErrorBoundary
      fallback={<ErrorFallback />}
      onError={(error, errorInfo) => {
        console.error('Global error:', error, errorInfo);
      }}
    >
      {children}
    </ErrorBoundary>
  );
}
```

---

## üöÄ **Escalabilidad y Mantenimiento**

### **1. Horizontal Scaling**
- **Modular architecture**: Nuevos m√≥dulos independientes
- **Service isolation**: Servicios desacoplados
- **Component reusability**: UI components reutilizables

### **2. Vertical Scaling**
- **Performance optimization**: Bundle splitting, lazy loading
- **Memory management**: Proper cleanup, memoization
- **Network optimization**: Query deduplication, caching

### **3. Code Maintainability**
- **TypeScript strict mode**: Type safety garantizada
- **Consistent patterns**: Architectural guidelines
- **Documentation**: Inline docs + external docs
- **Testing strategy**: Unit + integration tests

---

## üìã **Pr√≥ximos Pasos Arquitect√≥nicos**

### **1. Refactorizaci√≥n Cr√≠tica**
- [ ] **Unificar autenticaci√≥n** ‚Üí NextAuth.js
- [ ] **Centralizar estado global** ‚Üí Zustand/Redux Toolkit
- [ ] **Optimizar bundle size** ‚Üí Tree shaking mejorado

### **2. Mejoras de Performance**
- [ ] **Implementar PWA** ‚Üí Service Workers
- [ ] **Server-side rendering** ‚Üí P√°ginas cr√≠ticas
- [ ] **Database optimization** ‚Üí Query optimization

### **3. Developer Experience**
- [ ] **Testing framework** ‚Üí Vitest + Testing Library
- [ ] **Storybook integration** ‚Üí Component documentation
- [ ] **CI/CD pipeline** ‚Üí Automated deployment

---

*Documento actualizado: Septiembre 2024*
*Pr√≥xima revisi√≥n: Diciembre 2024*

# üìã N√≥minas H√≠bridas - Especificaciones Backend

## üéØ Resumen Ejecutivo

**¬øEs una migraci√≥n o funcionalidad nueva?**
- ‚úÖ **MIGRACI√ìN GRADUAL** - La funcionalidad antigua sigue funcionando igual
- ‚úÖ **EXTENSI√ìN** - Agregamos soporte para n√≥minas de facturas y mixtas
- ‚úÖ **COMPATIBILIDAD** - Todas las n√≥minas existentes se convierten autom√°ticamente a tipo "cheques"

**Estrategia de Implementaci√≥n:**
1. **Fase 1:** Migraci√≥n de base de datos (ya completada)
2. **Fase 2:** Backend APIs (actual)
3. **Fase 3:** Frontend gradual
4. **Fase 4:** Migraci√≥n completa a n√≥minas mixtas

---

## üóÑÔ∏è Base de Datos (Ya Implementada)

### Migraciones Aplicadas:
- ‚úÖ Campo `tipo_nomina` en `nominas_cantera` (default: 'cheques')
- ‚úÖ Tabla `nomina_factura` para asignar facturas
- ‚úÖ Campo `asignado_a_nomina` en `facturas`
- ‚úÖ Vista `v_nominas_completas` con informaci√≥n consolidada
- ‚úÖ Triggers autom√°ticos para mantener consistencia

### Compatibilidad:
```sql
-- Todas las n√≥minas existentes mantienen su funcionalidad
UPDATE nominas_cantera SET tipo_nomina = 'cheques' WHERE tipo_nomina IS NULL;
```

---

## üîß Nuevos Endpoints Requeridos

### 1. Crear N√≥mina Mixta
```http
POST /api-beta/nominas/mixta
Content-Type: application/json
Authorization: Bearer {token}

{
  "numeroNomina": "NOM-2024-001",
  "fechaEmision": "2024-12-19",
  "localOrigen": "Santiago",
  "facturas": [
    {
      "idFactura": "123",
      "montoAsignado": 50000
    }
  ],
  "cheques": [
    {
      "idCheque": "456",
      "montoAsignado": 50000
    }
  ]
}
```

**Respuesta:**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "numero_nomina": "NOM-2024-001",
    "tipo_nomina": "mixta",
    "balance": 0,
    "total_facturas": 50000,
    "total_cheques": 50000
  }
}
```

### 2. Asignar Facturas a N√≥mina Existente
```http
POST /api-beta/nominas/{id}/facturas
Content-Type: application/json
Authorization: Bearer {token}

{
  "facturas": [
    {
      "idFactura": "123",
      "montoAsignado": 25000
    }
  ]
}
```

### 3. Obtener Facturas Disponibles (no asignadas)
```http
GET /api-beta/facturas/disponibles?page=1&limit=20&proveedor=ABC&estado=pendiente
Authorization: Bearer {token}
```

**Respuesta:**
```json
{
  "data": [
    {
      "id": 123,
      "folio": "FAC-001",
      "proveedor": "ABC Ltda",
      "monto": 50000,
      "estado": "pendiente",
      "fecha_ingreso": "2024-12-15",
      "asignado_a_nomina": false
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 150,
    "hasNext": true
  }
}
```

### 4. Obtener N√≥mina con Detalles Completos
```http
GET /api-beta/nominas/{id}/completa
Authorization: Bearer {token}
```

**Respuesta:**
```json
{
  "id": 1,
  "numero_nomina": "NOM-2024-001",
  "fecha_emision": "2024-12-19",
  "estado": "pendiente",
  "tipo_nomina": "mixta",
  "local_origen": "Santiago",
  "creado_por": "Juan P√©rez",
  "created_at": "2024-12-19T10:00:00Z",
  "updated_at": "2024-12-19T10:00:00Z",
  "nombre_usuario": "Juan P√©rez",
  "id_usuario": 1,
  "monto_total": 100000,
  "cantidad_cheques": 2,
  "cantidad_facturas": 1,
  "total_facturas": 50000,
  "total_cheques": 50000,
  "balance": 0,
  "cheques": [...],
  "facturas": [...],
  "tracking_envio": {...}
}
```

### 5. Validar Balance de N√≥mina Mixta
```http
GET /api-beta/nominas/{id}/balance
Authorization: Bearer {token}
```

**Respuesta:**
```json
{
  "balance_valido": true,
  "total_facturas": 50000,
  "total_cheques": 50000,
  "diferencia": 0,
  "mensaje": "N√≥mina balanceada correctamente"
}
```

### 6. Obtener N√≥minas por Tipo
```http
GET /api-beta/nominas?tipo=mixta&page=1&limit=20
Authorization: Bearer {token}
```

### 7. Convertir N√≥mina a Mixta
```http
PUT /api-beta/nominas/{id}/convertir-mixta
Content-Type: application/json
Authorization: Bearer {token}

{
  "facturas": [
    {
      "idFactura": "123",
      "montoAsignado": 50000
    }
  ]
}
```

---

## üîç Consultas SQL Principales

### 1. Obtener N√≥minas con Informaci√≥n Completa
```sql
SELECT * FROM v_nominas_completas 
WHERE tipo_nomina IN ('mixta', 'facturas')
ORDER BY created_at DESC;
```

### 2. Facturas Disponibles (no asignadas)
```sql
SELECT f.*, p.nombre as nombre_proveedor
FROM facturas f
JOIN proveedores p ON f.id_proveedor = p.id
WHERE f.asignado_a_nomina = FALSE
AND f.estado = 'pendiente'
ORDER BY f.fecha_ingreso DESC;
```

### 3. Validar Balance de N√≥mina Mixta
```sql
SELECT 
  validar_balance_nomina_mixta(1) as balance_valido,
  COALESCE(SUM(nf.monto_asignado), 0) as total_facturas,
  COALESCE(SUM(nc.monto_asignado), 0) as total_cheques
FROM nominas_cantera nom
LEFT JOIN nomina_factura nf ON nom.id = nf.id_nomina
LEFT JOIN nomina_cheque nc ON nom.id = nc.id_nomina
WHERE nom.id = 1;
```

---

## üîÑ Rutas Existentes que Necesitan Extensi√≥n

### Rutas de N√≥minas (Ya implementadas):
```javascript
// Rutas existentes en mainRoutes.js
router.post('/nominas', authenticateToken, validateNomina, crearNominaController);
router.get('/nominas', authenticateToken, getAllNominasController);
router.get('/nominas/:id', authenticateToken, validateNominaId, getNominaByIdController);
router.get('/nominas/numero/:numero', authenticateToken, validateNominaNumero, getNominaByNumeroController);
router.put('/nominas/:id', authenticateToken, validateNominaId, validateNomina, actualizarNominaController);
router.delete('/nominas/:id', authenticateToken, validateNominaId, eliminarNominaController);
router.post('/nominas/:id/cheques', authenticateToken, validateNominaId, validateAsignacionChequeNomina, asignarChequeANominaController);
```

### Rutas de Facturas (Ya implementadas):
```javascript
// Rutas existentes en mainRoutes.js
router.get('/facturas', getAllFacturasController);
router.get('/facturas/:folio', getFactura);
router.get('/facturas/id/:id', validateFacturaId, cacheFacturaId, getFacturaByIdController);
router.patch('/facturas/:folio/estado', authenticateToken, cambiarEstadoFactura);
router.put('/facturas/:id/monto', authenticateToken, actualizarMontoFactura);
router.put('/facturas/:id/metodo-pago', authenticateToken, validateMetodoPago, actualizarMetodoPagoFactura);
```

### Extensiones Requeridas:

#### 1. Modificar `getAllNominasController`:
```javascript
// Agregar filtro por tipo_nomina
router.get('/nominas', authenticateToken, getAllNominasController);
// Query params: ?tipo=mixta&page=1&limit=20
```

#### 2. Modificar `getNominaByIdController`:
```javascript
// Incluir informaci√≥n de facturas asignadas
router.get('/nominas/:id', authenticateToken, validateNominaId, getNominaByIdController);
// Response debe incluir: facturas, total_facturas, balance
```

#### 3. Modificar `crearNominaController`:
```javascript
// Agregar soporte para tipo_nomina en el request
router.post('/nominas', authenticateToken, validateNomina, crearNominaController);
// Request body debe incluir: tipoNomina (opcional, default: 'cheques')
```

#### 4. Agregar nueva ruta para facturas disponibles:
```javascript
// Nueva ruta para facturas no asignadas
router.get('/facturas/disponibles', authenticateToken, getFacturasDisponiblesController);
// Query params: ?page=1&limit=20&proveedor=ABC&estado=pendiente
```

---

## ‚ö° Validaciones Requeridas

### 1. Balance en N√≥minas Mixtas
```sql
-- Validar que total_facturas = total_cheques
SELECT ABS(total_facturas - total_cheques) < 0.01 as balance_valido
FROM v_nominas_completas 
WHERE id = ? AND tipo_nomina = 'mixta';
```

### 2. Factura √önica por N√≥mina
```sql
-- Una factura no puede estar en m√∫ltiples n√≥minas
SELECT COUNT(*) = 0 as factura_disponible
FROM nomina_factura 
WHERE id_factura = ? AND id_nomina != ?;
```

### 3. Monto V√°lido
```sql
-- monto_asignado <= monto_factura
SELECT f.monto >= ? as monto_valido
FROM facturas f 
WHERE f.id = ?;
```

### 4. Estado de Factura
```sql
-- Solo facturas pendientes pueden asignarse
SELECT estado = 'pendiente' as estado_valido
FROM facturas 
WHERE id = ?;
```

---

## üîÑ Flujo de Trabajo

### Crear N√≥mina Mixta:
1. **Validar datos de entrada**
2. **Verificar que facturas y cheques existan**
3. **Confirmar que facturas no est√©n asignadas**
4. **Calcular balance autom√°ticamente**
5. **Insertar en `nomina_factura` y `nomina_cheque`**
6. **Actualizar `tipo_nomina` a 'mixta'**

### Asignar Facturas:
1. **Verificar disponibilidad de facturas**
2. **Validar montos asignados**
3. **Actualizar `asignado_a_nomina` en `facturas`**
4. **Recalcular balance de la n√≥mina**
5. **Actualizar `tipo_nomina` si es necesario**

### Validar Balance:
1. **Usar funci√≥n `validar_balance_nomina_mixta()`**
2. **Retornar estado de validaci√≥n**
3. **Incluir detalles de diferencia si no est√° balanceado**

---

## üìÅ Archivos de Referencia Frontend

### Tipos TypeScript (Ya actualizados):
- `src/types/nominaCheque.d.ts` - Tipos extendidos para n√≥minas h√≠bridas

### Servicios (Necesitan extensi√≥n):
- `src/services/nominaChequeService.ts` - Agregar m√©todos para facturas
- `src/services/facturaService.ts` - Agregar m√©todo para facturas disponibles

### Componentes (Nuevos necesarios):
- `src/components/dashboard/NominaMixtaContent.tsx`
- `src/components/dashboard/AsignarFacturasModal.tsx`

---

## üéØ Estrategia de Migraci√≥n

### Fase 1: Base de Datos ‚úÖ
- Migraciones SQL aplicadas
- Compatibilidad con sistema existente

### Fase 2: Backend APIs (Actual)
- Implementar nuevos endpoints
- Mantener compatibilidad con APIs existentes

### Fase 3: Frontend Gradual
- Nuevos componentes para n√≥minas mixtas
- Sistema existente sigue funcionando

### Fase 4: Migraci√≥n Completa
- Convertir n√≥minas existentes a mixtas
- Unificar interfaz de usuario

---

## ‚ö†Ô∏è Consideraciones Importantes

### Compatibilidad:
- ‚úÖ **N√≥minas existentes:** Siguen funcionando como "cheques"
- ‚úÖ **APIs existentes:** No se modifican
- ‚úÖ **Frontend actual:** No se rompe

### Migraci√≥n Gradual:
- üîÑ **Nuevas n√≥minas:** Pueden ser mixtas desde el inicio
- üîÑ **N√≥minas existentes:** Se pueden convertir a mixtas manualmente
- üîÑ **Sistema unificado:** Eventualmente todo ser√° mixto

### Validaciones:
- ‚ö° **Balance autom√°tico:** N√≥minas mixtas deben estar balanceadas
- ‚ö° **Facturas √∫nicas:** Una factura solo puede estar en una n√≥mina
- ‚ö° **Estados v√°lidos:** Solo facturas pendientes se pueden asignar

---

## üìû Informaci√≥n de Contacto

### Archivos de Referencia:
- **Base de datos:** `migrations/nominas_hibridas.sql`
- **Tipos TypeScript:** `src/types/nominaCheque.d.ts`
- **Esquema actualizado:** `railway.dbml`

### Pr√≥ximos Pasos:
1. **Implementar endpoints** seg√∫n especificaciones
2. **Crear servicios** para gesti√≥n de facturas en n√≥minas
3. **Implementar validaciones** de balance
4. **Actualizar endpoints existentes** para incluir `tipo_nomina`
5. **Crear tests** para validar funcionalidad

---

## üéØ Controladores que Necesitan Modificaci√≥n

### 1. `nominaCanteraController.js`
**M√©todos a modificar:**
- `crearNominaController` - Agregar soporte para `tipoNomina`
- `getAllNominasController` - Agregar filtro por `tipo_nomina`
- `getNominaByIdController` - Incluir informaci√≥n de facturas
- `actualizarNominaController` - Permitir cambio de tipo

**Nuevos m√©todos a crear:**
- `crearNominaMixtaController`
- `asignarFacturasANominaController`
- `validarBalanceNominaController`
- `convertirNominaAMixtaController`

### 2. `facturaController.js`
**M√©todos a modificar:**
- `getAllFacturasController` - Agregar filtro por `asignado_a_nomina`

**Nuevos m√©todos a crear:**
- `getFacturasDisponiblesController`
- `getFacturasAsignadasController`

### 3. Nuevos Controladores
**Crear:**
- `nominaFacturaController.js` - Gesti√≥n de asignaci√≥n facturas-n√≥minas
- `balanceNominaController.js` - Validaciones de balance

### 4. Middlewares de Validaci√≥n
**Agregar a `validation.js`:**
- `validateAsignacionFacturaNomina`
- `validateBalanceNomina`
- `validateTipoNomina`

---

## üìã Resumen de Implementaci√≥n Backend

### **Archivos a Modificar:**
1. **`mainRoutes.js`** - Agregar nuevas rutas
2. **`nominaCanteraController.js`** - Extender controladores existentes
3. **`facturaController.js`** - Agregar m√©todos para facturas disponibles
4. **`validation.js`** - Nuevos middlewares de validaci√≥n

### **Archivos a Crear:**
1. **`nominaFacturaController.js`** - Gesti√≥n de asignaci√≥n facturas-n√≥minas
2. **`balanceNominaController.js`** - Validaciones de balance

### **Nuevas Rutas en `mainRoutes.js`:**
```javascript
// Nuevas rutas para n√≥minas h√≠bridas
router.post('/nominas/mixta', authenticateToken, validateNomina, crearNominaMixtaController);
router.post('/nominas/:id/facturas', authenticateToken, validateNominaId, validateAsignacionFacturaNomina, asignarFacturasANominaController);
router.get('/nominas/:id/completa', authenticateToken, validateNominaId, getNominaCompletaController);
router.get('/nominas/:id/balance', authenticateToken, validateNominaId, validarBalanceNominaController);
router.put('/nominas/:id/convertir-mixta', authenticateToken, validateNominaId, convertirNominaAMixtaController);

// Nueva ruta para facturas disponibles
router.get('/facturas/disponibles', authenticateToken, getFacturasDisponiblesController);
```

### **Modificaciones en Rutas Existentes:**
```javascript
// Modificar para soportar filtro por tipo
router.get('/nominas', authenticateToken, getAllNominasController);
// Query params: ?tipo=mixta&page=1&limit=20

// Modificar para incluir informaci√≥n de facturas
router.get('/nominas/:id', authenticateToken, validateNominaId, getNominaByIdController);
// Response extendido con: facturas, total_facturas, balance
```

---

## üöÄ Plan de Implementaci√≥n Backend

### **Paso 1: Preparaci√≥n (1-2 d√≠as)**
- ‚úÖ Migraciones SQL (ya completadas)
- ‚úÖ Tipos TypeScript (ya actualizados)
- üìù Crear nuevos controladores base

### **Paso 2: Controladores Core (3-4 d√≠as)**
- üìù Implementar `nominaFacturaController.js`
- üìù Implementar `balanceNominaController.js`
- üìù Extender `nominaCanteraController.js`

### **Paso 3: Validaciones (1-2 d√≠as)**
- üìù Agregar middlewares en `validation.js`
- üìù Implementar validaciones de balance
- üìù Validaciones de facturas √∫nicas

### **Paso 4: Rutas y Testing (2-3 d√≠as)**
- üìù Agregar nuevas rutas en `mainRoutes.js`
- üìù Testing de endpoints
- üìù Validaci√≥n de compatibilidad

### **Paso 5: Documentaci√≥n y Deploy (1 d√≠a)**
- üìù Documentar APIs
- üìù Deploy a staging
- üìù Testing en producci√≥n

---

## ‚ö° Consideraciones T√©cnicas

### **Performance:**
- üöÄ Usar la vista `v_nominas_completas` para consultas optimizadas
- üöÄ Implementar cach√© para facturas disponibles
- üöÄ √çndices ya creados en migraciones

### **Seguridad:**
- üîí Validar permisos de usuario para asignar facturas
- üîí Validar que facturas pertenezcan al usuario
- üîí Sanitizar inputs de montos

### **Compatibilidad:**
- ‚úÖ Mantener todas las APIs existentes
- ‚úÖ N√≥minas existentes siguen funcionando
- ‚úÖ Migraci√≥n gradual sin breaking changes

---

## üìû Informaci√≥n Final

### **Archivos de Referencia:**
- **Base de datos:** `migrations/nominas_hibridas.sql`
- **Tipos TypeScript:** `src/types/nominaCheque.d.ts`
- **Rutas actuales:** `mainRoutes.js`
- **Esquema actualizado:** `railway.dbml`

### **Contacto para Implementaci√≥n:**
- **Prefijo API:** `/api-beta/`
- **Autenticaci√≥n:** Bearer Token
- **Validaciones:** Middlewares existentes + nuevos
- **Cach√©:** Redis (ya implementado)

### **Pr√≥ximos Pasos:**
1. **Revisar documentaci√≥n** con el equipo backend
2. **Implementar controladores** seg√∫n especificaciones
3. **Testing** de funcionalidad
4. **Deploy** gradual
5. **Frontend** (Fase 3)

---

## üöÄ Respuesta a la Pregunta Principal

**¬øEs migraci√≥n o funcionalidad nueva?**

**RESPUESTA:** Es una **MIGRACI√ìN GRADUAL** que mantiene toda la funcionalidad existente y agrega nuevas capacidades.

**¬øUsaremos mixta para ambas?**

**RESPUESTA:** **S√ç**, eventualmente todas las n√≥minas ser√°n mixtas, pero la migraci√≥n es gradual:

1. **Ahora:** N√≥minas existentes siguen siendo de "cheques"
2. **Nuevas:** Pueden ser "cheques", "facturas" o "mixtas"
3. **Futuro:** Todas ser√°n "mixtas" con capacidad de manejar ambos tipos

**Ventajas de este enfoque:**
- ‚úÖ No rompe funcionalidad existente
- ‚úÖ Permite migraci√≥n gradual
- ‚úÖ Mantiene compatibilidad
- ‚úÖ Facilita testing y validaci√≥n 